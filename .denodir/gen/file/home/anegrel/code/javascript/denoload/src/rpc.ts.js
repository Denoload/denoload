import log from "./log.ts";
const defaultRpcOptions = {
  timeout: 30000,
  transfer: []
};
const logger = log.getLogger("main");
let globalMsgId = 0;
export class RpcWorker {
  worker;
  responseHandlers = new Map();
  constructor(specifier, options){
    this.worker = new Worker(specifier, options);
    this.worker.onmessage = this.onResponse.bind(this);
  }
  terminate() {
    this.worker.terminate();
  }
  onResponse(event) {
    const responseId = event.data.id;
    const responseHandler = this.responseHandlers.get(responseId);
    if (!responseHandler) {
      throw new Error(`received unexpected response for rpc ${responseId}, no handler registered`);
    }
    responseHandler(event.data);
  }
  remoteProcedureCall(rpc, options = {}) {
    const { timeout, transfer } = {
      ...options,
      ...defaultRpcOptions
    };
    const msgId = globalMsgId++;
    return new Promise((resolve, reject)=>{
      const timeoutId = setTimeout(()=>{
        reject(`rpc ${msgId} timed out`);
      }, timeout);
      this.addResponseHandler(msgId, (data)=>{
        // Clear timeout and response handler.
        clearTimeout(timeoutId);
        this.removeResponseHandler(msgId);
        logger.debug(`rpc ${data.id} returned ${JSON.stringify(data)}`);
        if (data.error) {
          reject(data.error);
        }
        resolve(data.result);
      });
      logger.debug(`rpc ${msgId} called ${JSON.stringify(rpc)}`);
      this.worker.postMessage({
        id: msgId,
        ...rpc
      }, transfer);
    });
  }
  addResponseHandler(id, handler) {
    this.responseHandlers.set(id, handler);
  }
  removeResponseHandler(id) {
    this.responseHandlers.delete(id);
  }
}
export function workerProcedureHandler(// deno-lint-ignore no-explicit-any
procedures, // deno-lint-ignore no-explicit-any
postMessage) {
  const logger = log.getLogger("worker");
  // deno-lint-ignore no-explicit-any
  return async (event)=>{
    logger.debug(()=>`rpc ${event.data.id} received: ${JSON.stringify(event.data)}`);
    try {
      const procedure = procedures[event.data.name];
      if (typeof procedure !== "function") {
        throw new Error(`procedure "${event.data.name}" doesn't exist`);
      }
      const result = await procedure(...event.data.args);
      logger.debug(()=>`rpc ${event.data.id} done: ${JSON.stringify(result)}`);
      console.log(typeof result);
      postMessage({
        id: event.data.id,
        result
      }, result === undefined ? [] : [
        result
      ]);
    } catch (err) {
      logger.error(`rpc ${event.data.id} error: ${err.stack}`);
      const errStr = err.toString();
      postMessage({
        id: event.data.id,
        error: errStr
      }, []);
    }
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vaG9tZS9hbmVncmVsL2NvZGUvamF2YXNjcmlwdC9kZW5vbG9hZC9zcmMvcnBjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSBcIi4vbG9nLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUlBDPEE+IHtcbiAgaWQ6IG51bWJlcjtcbiAgbmFtZTogc3RyaW5nO1xuICBhcmdzOiBBW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnBjUmVzdWx0PFI+IHtcbiAgaWQ6IG51bWJlcjtcbiAgcmVzdWx0PzogUjtcbiAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnBjT3B0aW9ucyB7XG4gIHRpbWVvdXQ6IG51bWJlcjtcbiAgdHJhbnNmZXI6IFRyYW5zZmVyYWJsZVtdO1xufVxuXG5jb25zdCBkZWZhdWx0UnBjT3B0aW9uczogUnBjT3B0aW9ucyA9IHtcbiAgdGltZW91dDogMzAwMDAsXG4gIHRyYW5zZmVyOiBbXSxcbn07XG5cbmNvbnN0IGxvZ2dlciA9IGxvZy5nZXRMb2dnZXIoXCJtYWluXCIpO1xubGV0IGdsb2JhbE1zZ0lkID0gMDtcblxuLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbnR5cGUgUmVzcG9uc2VIYW5kbGVyID0gKF86IFJwY1Jlc3VsdDxhbnk+KSA9PiB2b2lkO1xuXG5leHBvcnQgY2xhc3MgUnBjV29ya2VyIHtcbiAgcHJpdmF0ZSByZWFkb25seSB3b3JrZXI6IFdvcmtlcjtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNwb25zZUhhbmRsZXJzOiBNYXA8bnVtYmVyLCBSZXNwb25zZUhhbmRsZXI+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKHNwZWNpZmllcjogc3RyaW5nIHwgVVJMLCBvcHRpb25zPzogV29ya2VyT3B0aW9ucyB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMud29ya2VyID0gbmV3IFdvcmtlcihzcGVjaWZpZXIsIG9wdGlvbnMpO1xuICAgIHRoaXMud29ya2VyLm9ubWVzc2FnZSA9IHRoaXMub25SZXNwb25zZS5iaW5kKHRoaXMpO1xuICB9XG5cbiAgdGVybWluYXRlKCkge1xuICAgIHRoaXMud29ya2VyLnRlcm1pbmF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblJlc3BvbnNlPFI+KGV2ZW50OiBNZXNzYWdlRXZlbnQ8UnBjUmVzdWx0PFI+Pikge1xuICAgIGNvbnN0IHJlc3BvbnNlSWQgPSBldmVudC5kYXRhLmlkO1xuICAgIGNvbnN0IHJlc3BvbnNlSGFuZGxlciA9IHRoaXMucmVzcG9uc2VIYW5kbGVycy5nZXQocmVzcG9uc2VJZCk7XG5cbiAgICBpZiAoIXJlc3BvbnNlSGFuZGxlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcmVjZWl2ZWQgdW5leHBlY3RlZCByZXNwb25zZSBmb3IgcnBjICR7cmVzcG9uc2VJZH0sIG5vIGhhbmRsZXIgcmVnaXN0ZXJlZGAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJlc3BvbnNlSGFuZGxlcihldmVudC5kYXRhKTtcbiAgfVxuXG4gIHJlbW90ZVByb2NlZHVyZUNhbGw8QSwgUj4oXG4gICAgcnBjOiB7IG5hbWU6IHN0cmluZzsgYXJnczogQVtdIH0sXG4gICAgb3B0aW9uczogUGFydGlhbDxScGNPcHRpb25zPiA9IHt9LFxuICApOiBQcm9taXNlPFIgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCB7IHRpbWVvdXQsIHRyYW5zZmVyIH0gPSB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgLi4uZGVmYXVsdFJwY09wdGlvbnMsXG4gICAgfTtcblxuICAgIGNvbnN0IG1zZ0lkID0gZ2xvYmFsTXNnSWQrKztcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVqZWN0KGBycGMgJHttc2dJZH0gdGltZWQgb3V0YCk7XG4gICAgICB9LCB0aW1lb3V0KTtcblxuICAgICAgdGhpcy5hZGRSZXNwb25zZUhhbmRsZXIobXNnSWQsIChkYXRhOiBScGNSZXN1bHQ8Uj4pID0+IHtcbiAgICAgICAgLy8gQ2xlYXIgdGltZW91dCBhbmQgcmVzcG9uc2UgaGFuZGxlci5cbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICAgIHRoaXMucmVtb3ZlUmVzcG9uc2VIYW5kbGVyKG1zZ0lkKTtcblxuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgYHJwYyAke2RhdGEuaWR9IHJldHVybmVkICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHJlamVjdChkYXRhLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc29sdmUoZGF0YS5yZXN1bHQpO1xuICAgICAgfSk7XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZyhgcnBjICR7bXNnSWR9IGNhbGxlZCAke0pTT04uc3RyaW5naWZ5KHJwYyl9YCk7XG4gICAgICB0aGlzLndvcmtlci5wb3N0TWVzc2FnZSh7IGlkOiBtc2dJZCwgLi4ucnBjIH0sIHRyYW5zZmVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVzcG9uc2VIYW5kbGVyKGlkOiBudW1iZXIsIGhhbmRsZXI6IFJlc3BvbnNlSGFuZGxlcikge1xuICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5zZXQoaWQsIGhhbmRsZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVSZXNwb25zZUhhbmRsZXIoaWQ6IG51bWJlcikge1xuICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5kZWxldGUoaWQpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3b3JrZXJQcm9jZWR1cmVIYW5kbGVyKFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBwcm9jZWR1cmVzOiBSZWNvcmQ8c3RyaW5nLCAoLi4uYXJnczogYW55W10pID0+IGFueT4sXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIHBvc3RNZXNzYWdlOiAobWVzc2FnZTogYW55LCB0cmFuc2ZlcjogVHJhbnNmZXJhYmxlW10pID0+IHZvaWQsXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4pOiAoXzogTWVzc2FnZUV2ZW50PFJQQzxhbnk+PikgPT4gdm9pZCB7XG4gIGNvbnN0IGxvZ2dlciA9IGxvZy5nZXRMb2dnZXIoXCJ3b3JrZXJcIik7XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgcmV0dXJuIGFzeW5jIChldmVudDogTWVzc2FnZUV2ZW50PFJQQzxhbnk+Pik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGxvZ2dlci5kZWJ1ZygoKSA9PlxuICAgICAgYHJwYyAke2V2ZW50LmRhdGEuaWR9IHJlY2VpdmVkOiAke0pTT04uc3RyaW5naWZ5KGV2ZW50LmRhdGEpfWBcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb2NlZHVyZSA9IHByb2NlZHVyZXNbZXZlbnQuZGF0YS5uYW1lXTtcbiAgICAgIGlmICh0eXBlb2YgcHJvY2VkdXJlICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBwcm9jZWR1cmUgXCIke2V2ZW50LmRhdGEubmFtZX1cIiBkb2Vzbid0IGV4aXN0YCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHByb2NlZHVyZSguLi5ldmVudC5kYXRhLmFyZ3MpO1xuXG4gICAgICBsb2dnZXIuZGVidWcoKCkgPT5cbiAgICAgICAgYHJwYyAke2V2ZW50LmRhdGEuaWR9IGRvbmU6ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX1gXG4gICAgICApO1xuXG4gICAgICBjb25zb2xlLmxvZyh0eXBlb2YgcmVzdWx0KTtcbiAgICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICAgaWQ6IGV2ZW50LmRhdGEuaWQsXG4gICAgICAgIHJlc3VsdCxcbiAgICAgIH0sIHJlc3VsdCA9PT0gdW5kZWZpbmVkID8gW10gOiBbcmVzdWx0XSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgIGBycGMgJHtldmVudC5kYXRhLmlkfSBlcnJvcjogJHtlcnIuc3RhY2t9YCxcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGVyclN0ciA9IGVyci50b1N0cmluZygpO1xuICAgICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICBpZDogZXZlbnQuZGF0YS5pZCxcbiAgICAgICAgZXJyb3I6IGVyclN0ciwgLy8gVE9ETyhuZWdyZWwpOiBzZXJpYWxpemUgYmVmb3JlIHBvc3RpbmcgbWVzc2FnZS5cbiAgICAgIH0sIFtdKTtcbiAgICB9XG4gIH07XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLFdBQVc7QUFtQjNCLE1BQU0sb0JBQWdDO0VBQ3BDLFNBQVM7RUFDVCxVQUFVLEVBQUU7QUFDZDtBQUVBLE1BQU0sU0FBUyxJQUFJLFNBQVMsQ0FBQztBQUM3QixJQUFJLGNBQWM7QUFLbEIsT0FBTyxNQUFNO0VBQ00sT0FBZTtFQUNmLG1CQUFpRCxJQUFJLE1BQU07RUFFNUUsWUFBWSxTQUF1QixFQUFFLE9BQW1DLENBQUU7SUFDeEUsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE9BQU8sV0FBVztJQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJO0VBQ25EO0VBRUEsWUFBWTtJQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUztFQUN2QjtFQUVRLFdBQWMsS0FBaUMsRUFBRTtJQUN2RCxNQUFNLGFBQWEsTUFBTSxJQUFJLENBQUMsRUFBRTtJQUNoQyxNQUFNLGtCQUFrQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDO0lBRWxELElBQUksQ0FBQyxpQkFBaUI7TUFD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