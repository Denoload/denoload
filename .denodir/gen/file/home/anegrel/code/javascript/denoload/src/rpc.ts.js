import log from "./log.ts";
const defaultRpcOptions = {
  timeout: 30000,
  transfer: []
};
const logger = log.getLogger("main");
let globalMsgId = 0;
export class RpcWorker {
  worker;
  responseHandlers = new Map();
  constructor(specifier, options){
    this.worker = new Worker(specifier, options);
    this.worker.onmessage = this.onResponse.bind(this);
  }
  terminate() {
    this.worker.terminate();
  }
  onResponse(event) {
    const responseId = event.data.id;
    const responseHandler = this.responseHandlers.get(responseId);
    if (!responseHandler) {
      throw new Error(`received unexpected response for rpc ${responseId}, no handler registered`);
    }
    responseHandler(event.data);
  }
  remoteProcedureCall(rpc, options = {}) {
    const { timeout, transfer } = {
      ...options,
      ...defaultRpcOptions
    };
    const msgId = globalMsgId++;
    return new Promise((resolve, reject)=>{
      const timeoutId = setTimeout(()=>{
        reject(`rpc ${msgId} timed out`);
      }, timeout);
      this.addResponseHandler(msgId, (data)=>{
        // Clear timeout and response handler.
        clearTimeout(timeoutId);
        this.removeResponseHandler(msgId);
        logger.debug(`rpc ${data.id} returned ${JSON.stringify(data)}`);
        if (data.error) {
          reject(data.error);
        }
        resolve(data.result);
      });
      logger.debug(`rpc ${msgId} called ${JSON.stringify(rpc)}`);
      this.worker.postMessage({
        id: msgId,
        ...rpc
      }, transfer);
    });
  }
  addResponseHandler(id, handler) {
    this.responseHandlers.set(id, handler);
  }
  removeResponseHandler(id) {
    this.responseHandlers.delete(id);
  }
}
export function workerProcedureHandler(// deno-lint-ignore no-explicit-any
procedures, // deno-lint-ignore no-explicit-any
postMessage) {
  const logger = log.getLogger("worker");
  // deno-lint-ignore no-explicit-any
  return async (event)=>{
    logger.debug(()=>`rpc ${event.data.id} received: ${JSON.stringify(event.data)}`);
    try {
      const procedure = procedures[event.data.name];
      if (typeof procedure !== "function") {
        throw new Error(`procedure "${event.data.name}" doesn't exist`);
      }
      const result = await procedure(...event.data.args);
      logger.debug(()=>`rpc ${event.data.id} done: ${JSON.stringify(result)}`);
      postMessage({
        id: event.data.id,
        result
      });
    } catch (err) {
      logger.error(`rpc ${event.data.id} error: ${err.stack}`);
      postMessage({
        id: event.data.id,
        error: err.toString()
      });
    }
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vaG9tZS9hbmVncmVsL2NvZGUvamF2YXNjcmlwdC9kZW5vbG9hZC9zcmMvcnBjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSBcIi4vbG9nLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUlBDPEE+IHtcbiAgaWQ6IG51bWJlcjtcbiAgbmFtZTogc3RyaW5nO1xuICBhcmdzOiBBW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnBjUmVzdWx0PFI+IHtcbiAgaWQ6IG51bWJlcjtcbiAgcmVzdWx0PzogUjtcbiAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnBjT3B0aW9ucyB7XG4gIHRpbWVvdXQ6IG51bWJlcjtcbiAgdHJhbnNmZXI6IFRyYW5zZmVyYWJsZVtdO1xufVxuXG5jb25zdCBkZWZhdWx0UnBjT3B0aW9uczogUnBjT3B0aW9ucyA9IHtcbiAgdGltZW91dDogMzAwMDAsXG4gIHRyYW5zZmVyOiBbXSxcbn07XG5cbmNvbnN0IGxvZ2dlciA9IGxvZy5nZXRMb2dnZXIoXCJtYWluXCIpO1xubGV0IGdsb2JhbE1zZ0lkID0gMDtcblxuLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbnR5cGUgUmVzcG9uc2VIYW5kbGVyID0gKF86IFJwY1Jlc3VsdDxhbnk+KSA9PiB2b2lkO1xuXG5leHBvcnQgY2xhc3MgUnBjV29ya2VyIHtcbiAgcHJpdmF0ZSByZWFkb25seSB3b3JrZXI6IFdvcmtlcjtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNwb25zZUhhbmRsZXJzOiBNYXA8bnVtYmVyLCBSZXNwb25zZUhhbmRsZXI+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKHNwZWNpZmllcjogc3RyaW5nIHwgVVJMLCBvcHRpb25zPzogV29ya2VyT3B0aW9ucyB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMud29ya2VyID0gbmV3IFdvcmtlcihzcGVjaWZpZXIsIG9wdGlvbnMpO1xuICAgIHRoaXMud29ya2VyLm9ubWVzc2FnZSA9IHRoaXMub25SZXNwb25zZS5iaW5kKHRoaXMpO1xuICB9XG5cbiAgdGVybWluYXRlKCkge1xuICAgIHRoaXMud29ya2VyLnRlcm1pbmF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblJlc3BvbnNlPFI+KGV2ZW50OiBNZXNzYWdlRXZlbnQ8UnBjUmVzdWx0PFI+Pikge1xuICAgIGNvbnN0IHJlc3BvbnNlSWQgPSBldmVudC5kYXRhLmlkO1xuICAgIGNvbnN0IHJlc3BvbnNlSGFuZGxlciA9IHRoaXMucmVzcG9uc2VIYW5kbGVycy5nZXQocmVzcG9uc2VJZCk7XG5cbiAgICBpZiAoIXJlc3BvbnNlSGFuZGxlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcmVjZWl2ZWQgdW5leHBlY3RlZCByZXNwb25zZSBmb3IgcnBjICR7cmVzcG9uc2VJZH0sIG5vIGhhbmRsZXIgcmVnaXN0ZXJlZGAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJlc3BvbnNlSGFuZGxlcihldmVudC5kYXRhKTtcbiAgfVxuXG4gIHJlbW90ZVByb2NlZHVyZUNhbGw8QSwgUj4oXG4gICAgcnBjOiB7IG5hbWU6IHN0cmluZzsgYXJnczogQVtdIH0sXG4gICAgb3B0aW9uczogUGFydGlhbDxScGNPcHRpb25zPiA9IHt9LFxuICApOiBQcm9taXNlPFIgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCB7IHRpbWVvdXQsIHRyYW5zZmVyIH0gPSB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgLi4uZGVmYXVsdFJwY09wdGlvbnMsXG4gICAgfTtcblxuICAgIGNvbnN0IG1zZ0lkID0gZ2xvYmFsTXNnSWQrKztcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVqZWN0KGBycGMgJHttc2dJZH0gdGltZWQgb3V0YCk7XG4gICAgICB9LCB0aW1lb3V0KTtcblxuICAgICAgdGhpcy5hZGRSZXNwb25zZUhhbmRsZXIobXNnSWQsIChkYXRhOiBScGNSZXN1bHQ8Uj4pID0+IHtcbiAgICAgICAgLy8gQ2xlYXIgdGltZW91dCBhbmQgcmVzcG9uc2UgaGFuZGxlci5cbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICAgIHRoaXMucmVtb3ZlUmVzcG9uc2VIYW5kbGVyKG1zZ0lkKTtcblxuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgYHJwYyAke2RhdGEuaWR9IHJldHVybmVkICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHJlamVjdChkYXRhLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc29sdmUoZGF0YS5yZXN1bHQpO1xuICAgICAgfSk7XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZyhgcnBjICR7bXNnSWR9IGNhbGxlZCAke0pTT04uc3RyaW5naWZ5KHJwYyl9YCk7XG4gICAgICB0aGlzLndvcmtlci5wb3N0TWVzc2FnZSh7IGlkOiBtc2dJZCwgLi4ucnBjIH0sIHRyYW5zZmVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVzcG9uc2VIYW5kbGVyKGlkOiBudW1iZXIsIGhhbmRsZXI6IFJlc3BvbnNlSGFuZGxlcikge1xuICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5zZXQoaWQsIGhhbmRsZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVSZXNwb25zZUhhbmRsZXIoaWQ6IG51bWJlcikge1xuICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5kZWxldGUoaWQpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3b3JrZXJQcm9jZWR1cmVIYW5kbGVyKFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBwcm9jZWR1cmVzOiBSZWNvcmQ8c3RyaW5nLCAoLi4uYXJnczogYW55W10pID0+IGFueT4sXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIHBvc3RNZXNzYWdlOiAoXzogUnBjUmVzdWx0PGFueT4pID0+IHZvaWQsXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4pOiAoXzogTWVzc2FnZUV2ZW50PFJQQzxhbnk+PikgPT4gdm9pZCB7XG4gIGNvbnN0IGxvZ2dlciA9IGxvZy5nZXRMb2dnZXIoXCJ3b3JrZXJcIik7XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgcmV0dXJuIGFzeW5jIChldmVudDogTWVzc2FnZUV2ZW50PFJQQzxhbnk+Pik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGxvZ2dlci5kZWJ1ZygoKSA9PlxuICAgICAgYHJwYyAke2V2ZW50LmRhdGEuaWR9IHJlY2VpdmVkOiAke0pTT04uc3RyaW5naWZ5KGV2ZW50LmRhdGEpfWBcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb2NlZHVyZSA9IHByb2NlZHVyZXNbZXZlbnQuZGF0YS5uYW1lXTtcbiAgICAgIGlmICh0eXBlb2YgcHJvY2VkdXJlICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBwcm9jZWR1cmUgXCIke2V2ZW50LmRhdGEubmFtZX1cIiBkb2Vzbid0IGV4aXN0YCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHByb2NlZHVyZSguLi5ldmVudC5kYXRhLmFyZ3MpO1xuXG4gICAgICBsb2dnZXIuZGVidWcoKCkgPT5cbiAgICAgICAgYHJwYyAke2V2ZW50LmRhdGEuaWR9IGRvbmU6ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX1gXG4gICAgICApO1xuXG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgIGlkOiBldmVudC5kYXRhLmlkLFxuICAgICAgICByZXN1bHQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgYHJwYyAke2V2ZW50LmRhdGEuaWR9IGVycm9yOiAke2Vyci5zdGFja31gLFxuICAgICAgKTtcblxuICAgICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICBpZDogZXZlbnQuZGF0YS5pZCxcbiAgICAgICAgZXJyb3I6IGVyci50b1N0cmluZygpLCAvLyBUT0RPKG5lZ3JlbCk6IHNlcmlhbGl6ZSBiZWZvcmUgcG9zdGluZyBtZXNzYWdlLlxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sU0FBUyxXQUFXO0FBbUIzQixNQUFNLG9CQUFnQztFQUNwQyxTQUFTO0VBQ1QsVUFBVSxFQUFFO0FBQ2Q7QUFFQSxNQUFNLFNBQVMsSUFBSSxTQUFTLENBQUM7QUFDN0IsSUFBSSxjQUFjO0FBS2xCLE9BQU8sTUFBTTtFQUNNLE9BQWU7RUFDZixtQkFBaUQsSUFBSSxNQUFNO0VBRTVFLFlBQVksU0FBdUIsRUFBRSxPQUFtQyxDQUFFO0lBQ3hFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxPQUFPLFdBQVc7SUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSTtFQUNuRDtFQUVBLFlBQVk7SUFDVixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVM7RUFDdkI7RUFFUSxXQUFjLEtBQWlDLEVBQUU7SUFDdkQsTUFBTSxhQUFhLE1BQU0sSUFBSSxDQUFDLEVBQUU7SUFDaEMsTUFBTSxrQkFBa0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQztJQUVsRCxJQUFJLENBQUMsaUJBQWlCO01BQ3BCLE1BQU0sSUFBSSxNQUNSLENBQUMscUNBQXFDLEVBQUUsV0FBVyx1QkFBdUIsQ0FBQztJQUUvRTtJQUVBLGdCQUFnQixNQUFNLElBQUk7RUFDNUI7RUFFQSxvQkFDRSxHQUFnQyxFQUNoQyxVQUErQixDQUFDLENBQUMsRUFD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